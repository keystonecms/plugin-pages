{% extends "@pages/admin/layout.twig" %}

{% block title %}Create page – Keystone{% endblock %}

{% block styles %}
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
    .ql-editor {
        min-height: 320px;
    }
</style>
{% endblock %}

{% block content %}
<form id="form-page-edit"
      method="post"
      action="/admin/pages/create"
      data-reload="false">

    {{ csrf() }}

    <div class="alert alert-success d-none"></div>
    <div class="alert alert-danger d-none"></div>

    <div class="mb-3">
        <label class="form-label">Title</label>
        <input name="title"
               class="form-control"
               value=""
               required>
    </div>

        <div class="mb-3">
        <label class="form-label">Slug</label>
        <input name="slug"
               class="form-control"
               value="">
    </div>
    <div class="mb-3">
    <label class="form-label">Template</label>
    <select name="template" class="form-select">
        <option value="default">Default</option>
        <option value="landing">Landing</option>
        <option value="homepage">Homepage</option>
        <option value="full-width">Full width</option>
    </select>
</div>

    <div class="mb-3">
        <label class="form-label">Content</label>

        {# Quill mount #}
        <div id="editor">

        </div>

        {# hidden textarea for AJAX serialize #}
        <textarea name="content_html" class="d-none"></textarea>
    </div>

    <button type="submit" class="btn btn-primary">
        Save
    </button>
</form>

{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="{{url}}/assets/js/multiform-ajax.js"></script>
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
(function () {

    const quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{ header: [2, 3, false] }],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['blockquote'],
                ['image'],
                ['clean']
            ]
        }
    });

    /* Media picker integration */
    const toolbar = quill.getModule('toolbar');
    toolbar.addHandler('image', function () {
        window.open(
            '/admin/media?picker=1',
            'mediaPicker',
            'width=900,height=600'
        );
    });

    /* sync quill → textarea before AJAX submit */
    $('form[id*=form]').on('submit', function () {
        $('textarea[name=content_html]').val(
            quill.root.innerHTML
        );
    });

    /* exposed for media picker */
    window.insertImage = function (url) {
        const range = quill.getSelection(true);
        quill.insertEmbed(range.index, 'image', url);
        quill.formatText(range.index, 1, 'alt', '');
        quill.setSelection(range.index + 1);
    };

})();
</script>
{% endblock %}